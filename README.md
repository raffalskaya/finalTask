# Распределённый вычислитель арифметических выражений

## Назначение

Данный проект предназначен для вычисления результата арифмитического выражения.

Проект являестся итоговым заданием курса [Программирование
на Go](https://lyceum.yandex.ru/go).

## Описание

Проект представляет собой демонстрацию распределённого веб-сервиса для вычисления результата арифмитического выражения.

Проект состоит из двух компонентов:

Агент — демон, который получает выражение для вычисления с сервера, вычисляет его и отправляет на сервер результат выражения. При старте демон запускает несколько горутин, каждая из которых выступает в роли независимого вычислителя. Количество горутин регулируется переменной среды COMPUTING_POWER. Агент общается с оркестратором по протоколу GRPC. Агент все время приходит к оркестратору с запросом "дай задачку поработать". Оркестратор отдаёт задачу. Агент производит вычисление и отдаёт результат оркестратору

Оркестратор — сервер, который принимает арифметическое выражение от пользователя, переводит его в набор последовательных задач и обеспечивает порядок их выполнения.

Стоит отметить, что работа оркестратора реализована в контексте пользователя и все данные хранятся в базе данных sqlite.
## Запуск проекта:
Для запуск проекта необходимо (сценарий запуска для linux или macos):
> **Примечание:**  перед запуском убедитесь, что порты 8000 и 50051 не занят другим приложением

1. Клонировать репозиторий с исходным кодом выполнив команду:
    ```bash
    git clone https://github.com/raffalskaya/finaltask.git
    ```
2. Перейти в каталог с проектом оркестратора выполнив команду:
    ```bash
    cd finaltask/orchestrator
    ```
3. Запустить оркестратор командой:
    ```bash
    go run .
    ```
4.  Открыть новое окно терминала и перейти в каталог с проектом, клонированного с github
   
5.  Перейти в каталог с проектом агента выполнив команду:
    ```bash
    cd ./agent
    ```
6. Запустить агент командой:
    ```bash
    go run .
    ```

Также проект можно запустить из VSCode. Для этого необходимо открыть клонированный репозиторий в VSCode.
Для запустка оркестратора создана конфигурация "Orchestrator"
Для запустка агента создана конфигурация "Agent"

## Схема взаимодействия системы
> **Примечание:**  более подробная схема находится в каталоге docs

```text
* - - - - - - - *                 * - - - - - - - *
|  оркестратор  | ---- задача---->|     агент     |
* - - - - - - - *                 * - - - - - - - *
        ^
    выражение
        |
* - - - - - - - *
|  пользователь |
* - - - - - - - *

```

## Сценарий использования

Первым делом необходимо зарегистрировать нового пользователя. Для отправки запроса на регистрацию пользователя необходимо выполнить команду:

```bash
    curl --location 'localhost:8000/api/v1/register' --header 'Content-Type: application/json' --data '{"name": "agent007", "OriginPassword": "12345"}'
```

```json
Коды ответа: 
200 - пользователь успешно зарегистрирован
302 - пользователь с таким именем уже существует
500 - что-то пошло не так
```

Затем необходимо войти с учётными данными, которые указаны при регистрации. Для отправки запроса на вход пользователя необходимо выполнить команду:

```bash
    curl --location 'localhost:8000/api/v1/login' --header 'Content-Type: application/json' --data '{"name": "agent007", "OriginPassword": "12345"}'
```

```json
Коды ответа: 
200 - пользователь успешно вошёл
403 - пользователю запрещён вход
500 - что-то пошло не так
```
В ответе вы должны получить 
```json
{
    "token": <уникальный токен пользователя>
}
```

Пользователь отправляет арифметическое выражение по протоколу HTTP в оркестратор на вычисление. Для получения запросов на вычисление от пользователя в оркестраторе реализован endpoint /api/v1/calculate.


```json
Коды ответа: 
201 - выражение принято для вычисления
422 - невалидные данные
403 - пользователь не вошёл в систему
500 - что-то пошло не так
```

Для отправки запроса на вычисление необходимо выполнить команду:
> **Примечание:**  не забудте заменить поле <ваш токен> в запросе на своё, которое получено на предыдущем шаге.
```bash
    curl --location 'localhost:8000/api/v1/calculate' --header 'Authorization: Bearer <ваш токен>' --header 'Content-Type: application/json' --data '{"expression": "4+3*2"}'
```
В ответе вы должны получить 
```json
{
    "id": <уникальный идентификатор выражения>
}
```

Также у пользователя есть возможность посмотреть все СВОИ выражения отправленные оркестратору на вычисление. Для этого реализован endpoint /api/v1/expressions

```json
Коды ответа:
200 - успешно получен список выражений
500 - что-то пошло не так
```

Для получения списка выражений необходимо выполнить следующую команду:
> **Примечание:**  не забудте заменить поле <ваш токен> в запросе на своё, которое получено на предыдущем шаге.
```bash
    curl --location 'localhost:8000/api/v1/expressions' --header 'Authorization: Bearer <ваш токен>'
```

В ответ вам вернётся список выражений следующей структуры:

```json
{
    "expressions": [
        {
            "id": <идентификатор выражения>,
            "status": <статус вычисления выражения>,
            "result": <результат выражения>
        },
        {
            "id": <идентификатор выражения>,
            "status": <статус вычисления выражения>,
            "result": <результат выражения>
        }
    ]
}
```
Также у пользователя есть возможность посмотреть конкретное СВОЁ выражение отправленое оркестратору на вычисление. Для этого реализован endpoint /api/v1/expressions/:id

```json
Коды ответа:
200 - успешно получено выражение
404 - нет такого выражения
500 - что-то пошло не так
```
Для получения конкретного выражения необходимо выполнить следующую команду:
> **Примечание:**  не забудте заменить поле <идентификатор выражения> на соответсвующее значение
> **Примечание:**  не забудте заменить поле <ваш токен> в запросе на своё, которое получено на предыдущем шаге.

```bash
curl --location 'localhost:8000/api/v1/expressions/<идентификатор выражения> --header 'Authorization: Bearer <ваш токен>'
```

В ответ вам вернётся выражение следующей структуры:

```json
{
    "expression":
        {
            "id": <идентификатор выражения>,
            "status": <статус вычисления выражения>,
            "result": <результат выражения>
        }
}
```


После добавления выражения для вычисления агент запрашивает у оркестратора задачу на вычисление по протоколу grpc. Интерфейс общения описан в файле proto/api.proto

Для получения задачи агент вызывает у оркестратора метод:
```proto
 rpc GetTask(google.protobuf.Empty) returns (TaskResponse);
```

После вычисления результата задачи агент вызывает у оркестратора метод:
```proto
 rpc SetTask(TaskResult) returns (google.protobuf.Empty);
```